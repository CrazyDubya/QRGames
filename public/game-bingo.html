<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bingo Game - QR Games</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .game-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
      font-size: 2.5em;
    }
    
    .game-info {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .current-number {
      font-size: 4em;
      font-weight: bold;
      color: #667eea;
      margin: 20px 0;
    }
    
    .called-numbers {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .called-numbers h3 {
      color: #333;
      margin-bottom: 15px;
    }
    
    .number-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .number-chip {
      background: #667eea;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: bold;
    }
    
    .bingo-card {
      background: white;
      border: 3px solid #667eea;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .card-header {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .card-letter {
      background: #667eea;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 1.5em;
      border-radius: 5px;
    }
    
    .card-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
    }
    
    .card-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.5em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .card-cell:hover:not(.marked):not(.free) {
      background: #e9ecef;
      transform: scale(1.05);
    }
    
    .card-cell.marked {
      background: #4caf50;
      color: white;
      border-color: #4caf50;
    }
    
    .card-cell.free {
      background: #667eea;
      color: white;
      border-color: #667eea;
      cursor: default;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.1em;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 10px;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .pattern-selector {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .pattern-selector h3 {
      color: #333;
      margin-bottom: 15px;
    }
    
    .pattern-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .pattern-btn {
      padding: 12px 24px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .pattern-btn:hover {
      background: #667eea;
      color: white;
    }
    
    .pattern-btn.selected {
      background: #667eea;
      color: white;
    }
    
    .button-container {
      text-align: center;
      margin-top: 20px;
    }
    
    .winner-banner {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      margin: 20px 0;
      font-size: 1.5em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="game-card">
      <h1>ðŸŽ¯ Bingo Game</h1>
      
      <div class="game-info">
        <div class="current-number" id="currentNumber">-</div>
        <button onclick="callNumber()" id="callBtn">Call Number</button>
      </div>
      
      <div class="called-numbers">
        <h3>Called Numbers (<span id="calledCount">0</span>)</h3>
        <div class="number-chips" id="calledNumbersList"></div>
      </div>
      
      <div class="bingo-card">
        <div class="card-header">
          <div class="card-letter">B</div>
          <div class="card-letter">I</div>
          <div class="card-letter">N</div>
          <div class="card-letter">G</div>
          <div class="card-letter">O</div>
        </div>
        <div class="card-grid" id="bingoCard"></div>
      </div>
      
      <div class="pattern-selector">
        <h3>Select Winning Pattern:</h3>
        <div class="pattern-options">
          <button class="pattern-btn" onclick="selectPattern('single-line')" id="pattern-single-line">
            Single Line
          </button>
          <button class="pattern-btn" onclick="selectPattern('4-corners')" id="pattern-4-corners">
            4 Corners
          </button>
          <button class="pattern-btn" onclick="selectPattern('full-card')" id="pattern-full-card">
            Full Card
          </button>
        </div>
      </div>
      
      <div class="button-container">
        <button onclick="claimBingo()" id="bingoBtn" disabled>BINGO!</button>
      </div>
      
      <div id="winnerBanner" style="display: none;" class="winner-banner"></div>
    </div>
  </div>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    let lobbyId;
    let myCard = [];
    let calledNumbers = [];
    let selectedPattern = 'single-line';
    let isHost = true; // Will be determined by socket connection
    
    const urlParams = new URLSearchParams(window.location.search);
    lobbyId = urlParams.get('lobby');
    
    if (!lobbyId) {
      alert('Invalid game link');
      window.location.href = '/';
    }
    
    function init() {
      socket = io();
      
      socket.on('game-started', (data) => {
        if (data.gameState) {
          calledNumbers = data.gameState.calledNumbers || [];
          updateCalledNumbers();
        }
        
        // Request player's bingo card
        fetch(`/api/lobby/${lobbyId}`)
          .then(res => res.json())
          .then(data => {
            const player = data.players.find(p => p.id === socket.id);
            if (player && player.bingoCard) {
              myCard = player.bingoCard;
              displayBingoCard();
            }
          });
      });
      
      socket.on('number-called', (data) => {
        calledNumbers = data.calledNumbers;
        document.getElementById('currentNumber').textContent = data.number;
        updateCalledNumbers();
        
        // Auto-mark if number is on card
        markNumberOnCard(data.number);
      });
      
      socket.on('number-marked', (data) => {
        // Number marked successfully
      });
      
      socket.on('bingo-winner', (data) => {
        showWinner(data.playerName, data.pattern);
      });
      
      socket.on('invalid-bingo', () => {
        alert('Invalid BINGO claim! Please check your card.');
      });
      
      // Initialize pattern selection
      selectPattern('single-line');
    }
    
    function displayBingoCard() {
      const cardGrid = document.getElementById('bingoCard');
      cardGrid.innerHTML = '';
      
      myCard.forEach((row, rowIndex) => {
        row.forEach((cell, colIndex) => {
          const cellDiv = document.createElement('div');
          cellDiv.className = 'card-cell';
          cellDiv.id = `cell-${rowIndex}-${colIndex}`;
          
          if (cell.value === 'FREE') {
            cellDiv.classList.add('free', 'marked');
            cellDiv.textContent = 'FREE';
          } else {
            cellDiv.textContent = cell.value;
            if (cell.marked) {
              cellDiv.classList.add('marked');
            }
            cellDiv.onclick = () => toggleCell(rowIndex, colIndex);
          }
          
          cardGrid.appendChild(cellDiv);
        });
      });
    }
    
    function toggleCell(row, col) {
      const cell = myCard[row][col];
      if (cell.value === 'FREE') return;
      
      // Only allow marking if number has been called
      if (!calledNumbers.includes(cell.value)) {
        alert('This number has not been called yet!');
        return;
      }
      
      cell.marked = !cell.marked;
      displayBingoCard();
      
      socket.emit('mark-number', { lobbyId, number: cell.value });
      
      // Check if can claim bingo
      checkBingoEligibility();
    }
    
    function markNumberOnCard(number) {
      let found = false;
      myCard.forEach(row => {
        row.forEach(cell => {
          if (cell.value === number) {
            cell.marked = true;
            found = true;
          }
        });
      });
      
      if (found) {
        displayBingoCard();
        checkBingoEligibility();
      }
    }
    
    function updateCalledNumbers() {
      document.getElementById('calledCount').textContent = calledNumbers.length;
      
      const list = document.getElementById('calledNumbersList');
      list.innerHTML = calledNumbers
        .sort((a, b) => b - a)
        .map(num => `<span class="number-chip">${num}</span>`)
        .join('');
    }
    
    function callNumber() {
      socket.emit('call-number', lobbyId);
    }
    
    function selectPattern(pattern) {
      selectedPattern = pattern;
      
      document.querySelectorAll('.pattern-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      document.getElementById(`pattern-${pattern}`).classList.add('selected');
      checkBingoEligibility();
    }
    
    function checkBingoEligibility() {
      const hasBingo = checkPattern(myCard, selectedPattern);
      document.getElementById('bingoBtn').disabled = !hasBingo;
    }
    
    function checkPattern(card, pattern) {
      if (pattern === 'single-line') {
        // Check rows
        for (let row of card) {
          if (row.every(cell => cell.marked)) {
            return true;
          }
        }
        
        // Check columns
        for (let col = 0; col < 5; col++) {
          if (card.every(row => row[col].marked)) {
            return true;
          }
        }
        
        // Check diagonals
        if (card.every((row, i) => row[i].marked)) {
          return true;
        }
        if (card.every((row, i) => row[4 - i].marked)) {
          return true;
        }
      } else if (pattern === '4-corners') {
        return card[0][0].marked && card[0][4].marked && 
               card[4][0].marked && card[4][4].marked;
      } else if (pattern === 'full-card') {
        return card.every(row => row.every(cell => cell.marked));
      }
      
      return false;
    }
    
    function claimBingo() {
      socket.emit('claim-bingo', { lobbyId, pattern: selectedPattern });
    }
    
    function showWinner(playerName, pattern) {
      const banner = document.getElementById('winnerBanner');
      banner.textContent = `ðŸŽ‰ ${playerName} won with ${pattern.replace('-', ' ')}! ðŸŽ‰`;
      banner.style.display = 'block';
      
      // Disable further play
      document.getElementById('bingoBtn').disabled = true;
      document.getElementById('callBtn').disabled = true;
    }
    
    init();
  </script>
</body>
</html>
